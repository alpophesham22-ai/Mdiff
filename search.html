<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>بحث وتعديل العملاء</title>
<style>
body { font-family: system-ui, sans-serif; margin: 16px; }
label { display: block; margin-top: 8px; }
input, button { font-size: 16px; padding: 8px; width: 100%; box-sizing: border-box; }
button { margin-top: 12px; }
#result { margin-top: 12px; background:#f0f0f0; padding:10px; border-radius:6px; }
</style>
</head>
<body>
<h1>🔎 بحث وتعديل العملاء</h1>

<label>ابحث بالـ ID أو الاسم</label>
<input id="query" placeholder="ادخل ID أو الاسم">
<button id="searchBtn">بحث</button>

<div id="result"></div>
<hr>
<button onclick="location.href='menu.html'">⬅ القائمة الرئيسية</button>

<script>
const DB='subsDB_final', STORE='subs';
const DAY_MS=24*60*60*1000;

// فتح IndexedDB
function openDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open(DB,1);
    r.onupgradeneeded = e => { e.target.result.createObjectStore(STORE, {keyPath:'id'}); };
    r.onsuccess = () => res(r.result);
    r.onerror = () => rej(r.error);
  });
}

// جلب جميع العملاء
function getAllSubs() {
  return new Promise(async (res, rej) => {
    const db = await openDB();
    const tx = db.transaction(STORE,'readonly');
    const store = tx.objectStore(STORE);
    const request = store.getAll();
    request.onsuccess = () => res(request.result);
    request.onerror = () => rej(request.error);
  });
}

// حفظ العميل
function saveSub(sub) {
  return new Promise(async (res, rej) => {
    const db = await openDB();
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).put(sub);
    tx.oncomplete = () => res();
    tx.onerror = () => rej(tx.error);
  });
}

// فحص حالة الاشتراك
function checkStatus(sub){
  const today = new Date();
  const endDate = new Date(sub.endDate);
  let reason='';
  if(today > endDate) reason='انتهى الاشتراك بسبب مرور الأيام';
  else {
    const remainingMeals = Object.values(sub.remaining).reduce((a,b)=>a+b,0);
    if(remainingMeals <= 0) reason='انتهى الاشتراك بسبب نفاد الوجبات';
  }
  return reason || 'ساري';
}

// البحث وعرض العميل
document.getElementById('searchBtn').addEventListener('click', async () => {
  const q = document.getElementById('query').value.trim().toLowerCase();
  const resultsDiv = document.getElementById('result');
  resultsDiv.innerHTML='';
  if(!q){ alert('ادخل ID أو الاسم'); return; }

  const subs = await getAllSubs();
  const matches = subs.filter(s=>s.id.toLowerCase()===q || s.name.toLowerCase()===q);

  if(matches.length===0){ resultsDiv.innerHTML='<p>لم يتم العثور على العميل.</p>'; return; }

  matches.forEach(sub=>{
    resultsDiv.innerHTML = `
      <label>الاسم</label>
      <input id="name" value="${sub.name}">
      <label>الجوال</label>
      <input id="phone" value="${sub.phone}">
      <label>اسم الاشتراك</label>
      <input id="subName" value="${sub.subName}">
      <label>المدة بالأيام</label>
      <input id="duration" type="number" value="${sub.duration}">
      <label>تاريخ البداية</label>
      <input id="startDate" type="date" value="${sub.startDate}">
      <p><strong>الحالة الحالية:</strong> ${checkStatus(sub)}</p>
      <button id="saveBtn">💾 حفظ التعديلات</button>
    `;

    document.getElementById('saveBtn').onclick = async () => {
      // تحديث بيانات العميل
      sub.name = document.getElementById('name').value.trim() || sub.name;
      sub.phone = document.getElementById('phone').value.trim() || sub.phone;
      sub.subName = document.getElementById('subName').value.trim() || sub.subName;
      sub.duration = parseInt(document.getElementById('duration').value) || sub.duration;
      sub.startDate = document.getElementById('startDate').value || sub.startDate;
      sub.endDate = new Date(new Date(sub.startDate).getTime() + sub.duration*DAY_MS)
                      .toISOString().slice(0,10);

      await saveSub(sub);
      alert('✅ تم حفظ التعديلات');
      document.getElementById('query').value = sub.id; // إعادة عرض العميل بعد التعديل
      document.getElementById('searchBtn').click();
    };
  });
});
</script>
</body>
</html>

  });
});
</script>
</body>

</html>
