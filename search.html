<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
<style>
body { font-family: system-ui, sans-serif; margin: 16px; }
label { display: block; margin-top: 8px; }
input, button { font-size: 16px; padding: 8px; width: 100%; box-sizing: border-box; }
button { margin-top: 12px; }
#result { margin-top: 12px; background:#f0f0f0; padding:10px; border-radius:6px; }
</style>
</head>
<body>
<h1>ðŸ”Ž Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>

<label>Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ ID Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…</label>
<input id="query" placeholder="Ø§Ø¯Ø®Ù„ ID Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…">
<button id="searchBtn">Ø¨Ø­Ø«</button>

<div id="result"></div>
<hr>
<button onclick="location.href='menu.html'">â¬… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<script>
const DB='subsDB_final', STORE='subs';
const DAY_MS=24*60*60*1000;

function openDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open(DB,1);
    r.onupgradeneeded = e => { e.target.result.createObjectStore(STORE, {keyPath:'id'}); };
    r.onsuccess = () => res(r.result);
    r.onerror = () => rej(r.error);
  });
}

function getAllSubs() {
  return new Promise(async (res, rej) => {
    const db = await openDB();
    const tx = db.transaction(STORE,'readonly');
    const store = tx.objectStore(STORE);
    const request = store.getAll();
    request.onsuccess = () => res(request.result);
    request.onerror = () => rej(request.error);
  });
}

function checkStatus(sub){
  const today = new Date();
  const endDate = new Date(sub.endDate);
  let reason='';
  if(today > endDate) reason='Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø³Ø¨Ø¨ Ù…Ø±ÙˆØ± Ø§Ù„Ø£ÙŠØ§Ù…';
  else {
    const remainingMeals = Object.values(sub.remaining).reduce((a,b)=>a+b,0);
    if(remainingMeals <= 0) reason='Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø³Ø¨Ø¨ Ù†ÙØ§Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª';
  }
  return reason || 'Ø³Ø§Ø±ÙŠ';
}

document.getElementById('searchBtn').addEventListener('click', async () => {
  const q = document.getElementById('query').value.trim().toLowerCase();
  const resultsDiv = document.getElementById('result');
  resultsDiv.innerHTML='';
  if(!q){ alert('Ø§Ø¯Ø®Ù„ ID Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…'); return; }

  const subs = await getAllSubs();
  const matches = subs.filter(s=>s.id.toLowerCase()===q || s.name.toLowerCase()===q);

  if(matches.length===0){ resultsDiv.innerHTML='<p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„.</p>'; return; }

  matches.forEach(sub=>{
    const status = checkStatus(sub);
    resultsDiv.innerHTML += `
      <p><strong>ID:</strong> ${sub.id}<br>
      <strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${sub.name}<br>
      <strong>Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> ${sub.phone}<br>
      <strong>Ø§Ø³Ù… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</strong> ${sub.subName}<br>
      <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</strong> ${sub.startDate}<br>
      <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</strong> ${sub.endDate}<br>
      <strong>Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</strong> Ø¯Ø¬Ø§Ø¬:${sub.remaining.Ø¯Ø¬Ø§Ø¬}, Ù„Ø­Ù…:${sub.remaining.Ù„Ø­Ù…}, Ø³Ù…Ùƒ:${sub.remaining.Ø³Ù…Ùƒ}, Ø³Ù†Ø§Ùƒ:${sub.remaining.Ø³Ù†Ø§Ùƒ}<br>
      <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${status}</p><hr>
    `;
  });
});
</script>
</body>
</html>