<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ” Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
<style>
body { font-family: sans-serif; margin:16px; }
label { display:block; margin-top:8px; }
input, button { font-size:16px; padding:8px; width:100%; box-sizing:border-box; }
button { margin-top:12px; }
#result { margin-top:12px; background:#f0f0f0; padding:10px; border-radius:6px; }
#msg { font-weight:bold; color:green; margin-top:8px; }
</style>
</head>
<body>

<h1>ğŸ” Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>

<label>Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ ID Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…</label>
<input id="query" placeholder="Ø§Ø¯Ø®Ù„ ID Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…">
<button id="searchBtn">Ø¨Ø­Ø«</button>

<div id="result">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø« Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
<hr>
<button onclick="location.href='import.html'">â¬… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<script>
const DB='ClientsDB', STORE='clients';
const DAY_MS=24*60*60*1000;

// ÙØªØ­ DB
function openDB() {
  return new Promise((res, rej)=>{
    const r = indexedDB.open(DB,1);
    r.onupgradeneeded = e => { e.target.result.createObjectStore(STORE,{keyPath:'id'}); };
    r.onsuccess = e => res(e.target.result);
    r.onerror = e => rej(e.target.error);
  });
}

// Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
function getAllSubs() {
  return openDB().then(db => new Promise((res, rej)=>{
    const tx = db.transaction(STORE,'readonly');
    const store = tx.objectStore(STORE);
    const req = store.getAll();
    req.onsuccess = ()=>res(req.result);
    req.onerror = ()=>rej(req.error);
  }));
}

// Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„
function saveClient(client) {
  return openDB().then(db => new Promise((res, rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).put(client);
    tx.oncomplete = ()=>res();
    tx.onerror = ()=>rej(tx.error);
  }));
}

function checkStatus(sub){
  const today = new Date();
  const endDate = new Date(sub.endDate);
  let reason='';
  if(today > endDate) reason='Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø³Ø¨Ø¨ Ù…Ø±ÙˆØ± Ø§Ù„Ø£ÙŠØ§Ù…';
  else {
    const remainingMeals = Object.values(sub.remaining).reduce((a,b)=>a+b,0);
    if(remainingMeals <= 0) reason='Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø³Ø¨Ø¨ Ù†ÙØ§Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª';
  }
  return reason || 'Ø³Ø§Ø±ÙŠ';
}

document.getElementById('searchBtn').addEventListener('click', async () => {
  const q = document.getElementById('query').value.trim().toLowerCase();
  const resultsDiv = document.getElementById('result');
  resultsDiv.innerHTML='';
  if(!q){ alert('Ø§Ø¯Ø®Ù„ ID Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…'); return; }

  const subs = await getAllSubs();
  const client = subs.find(s=>s.id.toLowerCase()===q || s.name.toLowerCase()===q);

  if(!client){ resultsDiv.innerHTML='<p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„.</p>'; return; }

  // Ù†Ù…ÙˆØ°Ø¬ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  resultsDiv.innerHTML = `
    <label>Ø§Ù„Ø§Ø³Ù…</label>
    <input id="name" value="${client.name}">
    <label>Ø§Ù„Ø¬ÙˆØ§Ù„</label>
    <input id="phone" value="${client.phone}">
    <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
    <input id="subName" value="${client.subName}">
    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
    <input id="startDate" type="date" value="${client.startDate}">
    <label>Ø§Ù„Ù…Ø¯Ø©</label>
    <input id="duration" type="number" value="${client.duration}">
    <label>Ø¯Ø¬Ø§Ø¬ Ù…ØªØ¨Ù‚ÙŠ</label>
    <input id="chicken" type="number" value="${client.remaining.Ø¯Ø¬Ø§Ø¬}">
    <label>Ù„Ø­Ù… Ù…ØªØ¨Ù‚ÙŠ</label>
    <input id="meat" type="number" value="${client.remaining.Ù„Ø­Ù…}">
    <label>Ø³Ù…Ùƒ Ù…ØªØ¨Ù‚ÙŠ</label>
    <input id="fish" type="number" value="${client.remaining.Ø³Ù…Ùƒ}">
    <label>Ø³Ù†Ø§Ùƒ Ù…ØªØ¨Ù‚ÙŠ</label>
    <input id="snack" type="number" value="${client.remaining.Ø³Ù†Ø§Ùƒ}">
    <button id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    <p id="msg"></p>
  `;

  document.getElementById('saveBtn').onclick = async ()=>{
    client.name = document.getElementById('name').value.trim();
    client.phone = document.getElementById('phone').value.trim();
    client.subName = document.getElementById('subName').value.trim();
    client.startDate = document.getElementById('startDate').value;
    client.duration = parseInt(document.getElementById('duration').value) || client.duration;
    client.endDate = new Date(new Date(client.startDate).getTime() + client.duration*DAY_MS)
                      .toISOString().slice(0,10);
    client.remaining.Ø¯Ø¬Ø§Ø¬ = parseInt(document.getElementById('chicken').value)||0;
    client.remaining.Ù„Ø­Ù… = parseInt(document.getElementById('meat').value)||0;
    client.remaining.Ø³Ù…Ùƒ = parseInt(document.getElementById('fish').value)||0;
    client.remaining.Ø³Ù†Ø§Ùƒ = parseInt(document.getElementById('snack').value)||0;

    await saveClient(client);
    document.getElementById('msg').textContent='âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­';
  };
});
</script>
</body>
</html>
