<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>๐ ุงุณุชูุฑุงุฏ / ุชุตุฏูุฑ ุงูุนููุงุก</title>
<style>
body { font-family: sans-serif; padding: 20px; background:#f8f8f8; }
input, button { padding:10px; font-size:16px; margin:5px 0; width:100%; box-sizing:border-box; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; background:#fff; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background:#eee; }
#msg { margin-top:10px; font-weight:bold; color:green; }
</style>
</head>
<body>

<h1>๐ ุงุณุชูุฑุงุฏ / ุชุตุฏูุฑ ุงูุนููุงุก</h1>

<h3>ุฑูุน ููู CSV</h3>
<input type="file" id="csvFile" accept=".csv">
<button onclick="importCSV()">๐ฅ ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช</button>

<h3>ุชุตุฏูุฑ CSV</h3>
<button onclick="exportCSV()">โฌ๏ธ ุชุตุฏูุฑ ุฌููุน ุงูุจูุงูุงุช</button>

<p id="msg"></p>
<hr>

<h3>ุนุฑุถ ุงูุนููุงุก ุงููุฎุฒููู</h3>
<table id="customersTable">
<thead>
<tr>
<th>ID</th>
<th>ุงูุงุณู</th>
<th>ุงูุฌูุงู</th>
<th>ููุน ุงูุงุดุชุฑุงู</th>
<th>ุงููุฏุฉ</th>
<th>ุจุฏุงูุฉ ุงูุงุดุชุฑุงู</th>
<th>ููุงูุฉ ุงูุงุดุชุฑุงู</th>
<th>ุฅุฌูุงูู ุงููุฌุจุงุช</th>
<th>ุฏุฌุงุฌ</th>
<th>ูุญู</th>
<th>ุณูู</th>
<th>ุณูุงู</th>
<th>ุชุนุฏูู</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const DB_NAME = 'ClientsDB';
const STORE_NAME = 'clients';

// ูุชุญ IndexedDB
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
    request.onsuccess = e => resolve(e.target.result);
    request.onerror = e => reject(e.target.error);
  });
}

// ุญูุธ ุนููู
function saveClient(client) {
  return openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).put(client);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  }));
}

// ุฌูุจ ุฌููุน ุงูุนููุงุก
function getAllClients() {
  return openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  }));
}

// ุงุณุชูุฑุงุฏ CSV
function importCSV() {
  const fileInput = document.getElementById('csvFile');
  if (!fileInput.files.length) { alert("ุงุฎุชุฑ ููู CSV ุฃููุงู"); return; }

  const reader = new FileReader();
  reader.onload = async e => {
    const lines = e.target.result.trim().split("\n").map(r => r.split(","));
    const DAY_MS = 24*60*60*1000;
    let count = 0;

    for (let i=1; i<lines.length; i++) {
      if (!lines[i].join("").trim()) continue;
      const [id,name,phone,subName,duration,startDate,totalAllowed,chicken,meat,fish,snack] = lines[i];
      const dur = parseInt(duration)||0;
      const start = startDate.trim();

      const client = {
        id: id.trim(),
        name: name.trim(),
        phone: phone.trim(),
        subName: subName.trim(),
        duration: dur,
        startDate: start,
        endDate: new Date(new Date(start).getTime()+dur*DAY_MS).toISOString().slice(0,10),
        totalAllowed: parseInt(totalAllowed)||0,
        consumed: {ุฏุฌุงุฌ:0, ูุญู:0, ุณูู:0, ุณูุงู:0},
        remaining: {
          ุฏุฌุงุฌ: parseInt(chicken)||0,
          ูุญู: parseInt(meat)||0,
          ุณูู: parseInt(fish)||0,
          ุณูุงู: parseInt(snack)||0
        },
        createdAt: new Date().toISOString()
      };

      await saveClient(client);
      count++;
    }

    document.getElementById('msg').textContent = `โ ุชู ุงุณุชูุฑุงุฏ ${count} ุนููู ูุญูุธูู ูุญููุงู`;
    loadFromDB();
  };

  reader.readAsText(fileInput.files[0]);
}

// ุนุฑุถ ุงูุนููุงุก ูุน ุฒุฑ ุชุนุฏูู
function loadFromDB() {
  getAllClients().then(clients => {
    const tbody = document.querySelector("#customersTable tbody");
    tbody.innerHTML = "";

    clients.forEach(c => {
      const tr = document.createElement("tr");

      // ุจูุงูุงุช ุงูุนููู
      [
        c.id, c.name, c.phone, c.subName, c.duration, c.startDate, c.endDate, c.totalAllowed,
        c.remaining.ุฏุฌุงุฌ, c.remaining.ูุญู, c.remaining.ุณูู, c.remaining.ุณูุงู
      ].forEach(val => {
        const td = document.createElement("td");
        td.textContent = val;
        tr.appendChild(td);
      });

      // ุฒุฑ ุชุนุฏูู
      const editTd = document.createElement("td");
      const editBtn = document.createElement("button");
      editBtn.textContent = "โ๏ธ ุชุนุฏูู";
      editBtn.style.cursor = "pointer";
      editBtn.onclick = async () => {
        const newName = prompt("ุงูุงุณู:", c.name) || c.name;
        const newPhone = prompt("ุงูุฌูุงู:", c.phone) || c.phone;
        const newSub = prompt("ููุน ุงูุงุดุชุฑุงู:", c.subName) || c.subName;
        const newDur = parseInt(prompt("ุงููุฏุฉ:", c.duration)) || c.duration;

        // ุชุญุฏูุซ ุงูุจูุงูุงุช
        c.name = newName;
        c.phone = newPhone;
        c.subName = newSub;
        c.duration = newDur;
        c.endDate = new Date(new Date(c.startDate).getTime() + newDur*24*60*60*1000).toISOString().slice(0,10);

        await saveClient(c); // ุชุญุฏูุซ ูู IndexedDB
        loadFromDB(); // ุฅุนุงุฏุฉ ุชุญููู ุงูุฌุฏูู
      };
      editTd.appendChild(editBtn);
      tr.appendChild(editTd);

      tbody.appendChild(tr);
    });
  });
}

// ุชุตุฏูุฑ CSV
function exportCSV() {
  getAllClients().then(clients => {
    if (!clients.length) { alert("ูุง ููุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ"); return; }
    let csv = "id,name,phone,subName,duration,startDate,endDate,totalAllowed,chicken,meat,fish,snack\n";
    clients.forEach(c => {
      csv += [
        c.id, c.name, c.phone, c.subName, c.duration, c.startDate, c.endDate, c.totalAllowed,
        c.remaining.ุฏุฌุงุฌ, c.remaining.ูุญู, c.remaining.ุณูู, c.remaining.ุณูุงู
      ].join(",") + "\n";
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "clients.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  });
}

// ุนุฑุถ ุชููุงุฆู ุนูุฏ ูุชุญ ุงูุตูุญุฉ
loadFromDB();
</script>
</body>
</html>


// ุนุฑุถ ุชููุงุฆู ุนูุฏ ูุชุญ ุงูุตูุญุฉ
loadFromDB();
</script>
</body>
</html>

