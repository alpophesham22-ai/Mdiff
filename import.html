<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>📋 استيراد / تصدير العملاء</title>
<style>
body { font-family: sans-serif; padding:20px; background:#f8f8f8; }
input, button { padding:10px; font-size:16px; margin:5px 0; width:100%; box-sizing:border-box; }
table { border-collapse: collapse; width:100%; margin-top:20px; background:#fff; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#eee; }
.client-buttons button { padding:4px 6px; }
#msg { margin-top:10px; font-weight:bold; color:green; }
</style>
</head>
<body>

<h1>📋 استيراد / تصدير العملاء</h1>

<h3>رفع ملف CSV</h3>
<input type="file" id="csvFile" accept=".csv">
<button onclick="importCSV()">📥 استيراد البيانات</button>

<h3>تصدير CSV</h3>
<button onclick="exportCSV()">⬇️ تصدير جميع البيانات</button>

<p id="msg"></p>
<hr>

<h3>عرض العملاء المخزنين</h3>
<table id="customersTable">
<thead>
<tr>
<th>ID</th><th>الاسم</th><th>الجوال</th><th>نوع الاشتراك</th>
<th>المدة</th><th>بداية الاشتراك</th><th>نهاية الاشتراك</th>
<th>دجاج</th><th>لحم</th><th>سمك</th><th>سناك</th><th>تعديل</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const DB_NAME='ClientsDB', STORE_NAME='clients', DAY_MS=24*60*60*1000;

function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=e=>e.target.result.createObjectStore(STORE_NAME,{keyPath:'id'}); r.onsuccess=e=>res(e.target.result); r.onerror=e=>rej(e.target.error); }); }
function saveClient(c){ return openDB().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(STORE_NAME,'readwrite'); tx.objectStore(STORE_NAME).put(c); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); })); }
function getAllClients(){ return openDB().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(STORE_NAME,'readonly'); const store=tx.objectStore(STORE_NAME); const req=store.getAll(); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); })); }

function importCSV(){
  const fileInput=document.getElementById('csvFile');
  if(!fileInput.files.length){ alert("اختر ملف CSV"); return; }
  const reader=new FileReader();
  reader.onload=async e=>{
    const lines=e.target.result.trim().split("\n").map(r=>r.split(","));
    let count=0;
    for(let i=1;i<lines.length;i++){
      if(!lines[i].join("").trim()) continue;
      const [id,name,phone,subName,duration,startDate,chicken,meat,fish,snack]=lines[i];
      const dur=parseInt(duration)||0;
      const start=startDate.trim();
      const client={
        id:id.trim(), name:name.trim(), phone:phone.trim(), subName:subName.trim(),
        duration:dur, startDate:start,
        endDate:new Date(new Date(start).getTime()+dur*DAY_MS).toISOString().slice(0,10),
        remaining:{دجاج:parseInt(chicken)||0,لحم:parseInt(meat)||0,سمك:parseInt(fish)||0,سناك:parseInt(snack)||0},
        createdAt:new Date().toISOString()
      };
      await saveClient(client); count++;
    }
    document.getElementById('msg').textContent=`✅ تم استيراد ${count} عميل وحفظهم محلياً`;
    loadFromDB();
  };
  reader.readAsText(fileInput.files[0]);
}

function loadFromDB(){
  getAllClients().then(clients=>{
    const tbody=document.querySelector("#customersTable tbody");
    tbody.innerHTML="";
    clients.forEach(c=>{
      const tr=document.createElement("tr");
      [c.id,c.name,c.phone,c.subName,c.duration,c.startDate,c.endDate,c.remaining.دجاج,c.remaining.لحم,c.remaining.سمك,c.remaining.سناك].forEach(v=>{
        const td=document.createElement("td"); td.textContent=v; tr.appendChild(td);
      });
      const tdEdit=document.createElement("td");
      const btn=document.createElement("button");
      btn.textContent="✏️ تعديل"; btn.onclick=()=>location.href=`search.html?id=${c.id}`;
      tdEdit.appendChild(btn); tr.appendChild(tdEdit);
      tbody.appendChild(tr);
    });
  });
}

function exportCSV(){
  getAllClients().then(clients=>{
    if(!clients.length){ alert("لا يوجد بيانات"); return; }
    let csv="id,name,phone,subName,duration,startDate,endDate,chicken,meat,fish,snack\n";
    clients.forEach(c=>{
      csv+=[c.id,c.name,c.phone,c.subName,c.duration,c.startDate,c.endDate,c.remaining.دجاج,c.remaining.لحم,c.remaining.سمك,c.remaining.سناك].join(",")+"\n";
    });
    const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download="clients.csv"; a.click(); URL.revokeObjectURL(a.href);
  });
}

loadFromDB();
</script>
</body>
</html>
