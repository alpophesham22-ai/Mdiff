<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>استيراد وتصدير البيانات</title>
<style>
body { font-family: system-ui, sans-serif; margin: 16px; }
input, button { font-size: 16px; padding: 8px; width: 100%; box-sizing: border-box; margin-top: 8px; }
#msg { margin-top: 12px; color: green; }
</style>
</head>
<body>
<h1>⬆️ استيراد / ⬇️ تصدير بيانات</h1>

<label>رفع ملف CSV</label>
<input type="file" id="csvFile" accept=".csv">
<button id="importBtn">استيراد البيانات</button>

<button id="exportBtn">تصدير جميع البيانات CSV</button>
<p id="msg"></p>
<hr>
<button onclick="location.href='menu.html'">⬅ القائمة الرئيسية</button>

<script>
const DB='subsDB_final', STORE='subs';

function openDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open(DB,1);
    r.onupgradeneeded = e => { e.target.result.createObjectStore(STORE, {keyPath:'id'}); };
    r.onsuccess = () => res(r.result);
    r.onerror = () => rej(r.error);
  });
}

function putSub(sub) {
  return new Promise(async (res, rej) => {
    const db = await openDB();
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).put(sub);
    tx.oncomplete = () => res();
    tx.onerror = () => rej(tx.error);
  });
}

function getAllSubs() {
  return new Promise(async (res, rej) => {
    const db = await openDB();
    const tx = db.transaction(STORE,'readonly');
    const store = tx.objectStore(STORE);
    const request = store.getAll();
    request.onsuccess = () => res(request.result);
    request.onerror = () => rej(request.error);
  });
}

// استيراد CSV
document.getElementById('importBtn').addEventListener('click', ()=>{
  const file = document.getElementById('csvFile').files[0];
  if(!file){ alert('اختر ملف CSV'); return; }
  const reader = new FileReader();
  reader.onload = async e => {
    const lines = e.target.result.split(/\r?\n/);
    for(let i=1;i<lines.length;i++){
      const row = lines[i].split(',');
      if(row.length<11) continue;
      const [id,name,phone,subName,duration,startDate,endDate,totalAllowed,chicken,meat,fish,snack] = row;
      const sub = {
        id,id,name,phone,subName,duration:parseInt(duration),startDate,endDate,
        totalAllowed:parseInt(totalAllowed),
        consumed:{دجاج:0,لحم:0,سمك:0,سناك:0},
        remaining:{دجاج:parseInt(chicken),لحم:parseInt(meat),سمك:parseInt(fish),سناك:parseInt(snack)}
      };
      await putSub(sub);
    }
    document.getElementById('msg').textContent='تم استيراد البيانات بنجاح';
  };
  reader.readAsText(file);
});

// تصدير CSV
document.getElementById('exportBtn').addEventListener('click', async ()=>{
  const subs = await getAllSubs();
  let csv='ID,الاسم,الجوال,اسم الاشتراك,مدة,تاريخ البداية,تاريخ الانتهاء,اجمالي الوجبات,دجاج,لحم,سمك,سناك\n';
  subs.forEach(s=>{
    csv += `${s.id},${s.name},${s.phone},${s.subName},${s.duration},${s.startDate},${s.endDate},${s.totalAllowed},${s.remaining.دجاج},${s.remaining.لحم},${s.remaining.سمك},${s.remaining.سناك}\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download='clients.csv';
  a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>