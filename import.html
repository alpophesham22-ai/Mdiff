<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ / ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
<style>
body { font-family: sans-serif; padding: 20px; background:#f8f8f8; }
input, button { padding:10px; font-size:16px; margin:5px 0; width:100%; box-sizing:border-box; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; background:#fff; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background:#eee; }
#msg { margin-top:10px; font-weight:bold; color:green; }
</style>
</head>
<body>

<h1>ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ / ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>

<h3>Ø±ÙØ¹ Ù…Ù„Ù CSV</h3>
<input type="file" id="csvFile" accept=".csv">
<button onclick="importCSV()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

<h3>ØªØµØ¯ÙŠØ± CSV</h3>
<button onclick="exportCSV()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

<p id="msg"></p>
<hr>

<h3>Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠÙ†</h3>
<table id="customersTable">
<thead>
<tr>
<th>ID</th>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
<th>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
<th>Ø§Ù„Ù…Ø¯Ø©</th>
<th>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
<th>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
<th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</th>
<th>Ø¯Ø¬Ø§Ø¬</th>
<th>Ù„Ø­Ù…</th>
<th>Ø³Ù…Ùƒ</th>
<th>Ø³Ù†Ø§Ùƒ</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const DB_NAME = 'ClientsDB';
const STORE_NAME = 'clients';

// ÙØªØ­ IndexedDB
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
    request.onsuccess = e => resolve(e.target.result);
    request.onerror = e => reject(e.target.error);
  });
}

// Ø­ÙØ¸ Ø¹Ù…ÙŠÙ„
function saveClient(client) {
  return openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).put(client);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  }));
}

// Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
function getAllClients() {
  return openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  }));
}

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV
function importCSV() {
  const fileInput = document.getElementById('csvFile');
  if (!fileInput.files.length) { alert("Ø§Ø®ØªØ± Ù…Ù„Ù CSV Ø£ÙˆÙ„Ø§Ù‹"); return; }

  const reader = new FileReader();
  reader.onload = async e => {
    const lines = e.target.result.trim().split("\n").map(r => r.split(","));
    const DAY_MS = 24*60*60*1000;
    let count = 0;

    for (let i=1; i<lines.length; i++) {
      if (!lines[i].join("").trim()) continue;
      const [id,name,phone,subName,duration,startDate,totalAllowed,chicken,meat,fish,snack] = lines[i];
      const dur = parseInt(duration)||0;
      const start = startDate.trim();

      const client = {
        id: id.trim(),
        name: name.trim(),
        phone: phone.trim(),
        subName: subName.trim(),
        duration: dur,
        startDate: start,
        endDate: new Date(new Date(start).getTime()+dur*DAY_MS).toISOString().slice(0,10),
        totalAllowed: parseInt(totalAllowed)||0,
        consumed: {Ø¯Ø¬Ø§Ø¬:0, Ù„Ø­Ù…:0, Ø³Ù…Ùƒ:0, Ø³Ù†Ø§Ùƒ:0},
        remaining: {
          Ø¯Ø¬Ø§Ø¬: parseInt(chicken)||0,
          Ù„Ø­Ù…: parseInt(meat)||0,
          Ø³Ù…Ùƒ: parseInt(fish)||0,
          Ø³Ù†Ø§Ùƒ: parseInt(snack)||0
        },
        createdAt: new Date().toISOString()
      };

      await saveClient(client);
      count++;
    }

    document.getElementById('msg').textContent = `âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${count} Ø¹Ù…ÙŠÙ„ ÙˆØ­ÙØ¸Ù‡Ù… Ù…Ø­Ù„ÙŠØ§Ù‹`;
    loadFromDB();
  };

  reader.readAsText(fileInput.files[0]);
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
function loadFromDB() {
  getAllClients().then(clients => {
    const tbody = document.querySelector("#customersTable tbody");
    tbody.innerHTML = "";
    clients.forEach(c => {
      const tr = document.createElement("tr");
      [
        c.id, c.name, c.phone, c.subName, c.duration, c.startDate, c.endDate, c.totalAllowed,
        c.remaining.Ø¯Ø¬Ø§Ø¬, c.remaining.Ù„Ø­Ù…, c.remaining.Ø³Ù…Ùƒ, c.remaining.Ø³Ù†Ø§Ùƒ
      ].forEach(val => {
        const td = document.createElement("td");
        td.textContent = val;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  });
}

// ØªØµØ¯ÙŠØ± CSV
function exportCSV() {
  getAllClients().then(clients => {
    if (!clients.length) { alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±"); return; }
    let csv = "id,name,phone,subName,duration,startDate,endDate,totalAllowed,chicken,meat,fish,snack\n";
    clients.forEach(c => {
      csv += [
        c.id, c.name, c.phone, c.subName, c.duration, c.startDate, c.endDate, c.totalAllowed,
        c.remaining.Ø¯Ø¬Ø§Ø¬, c.remaining.Ù„Ø­Ù…, c.remaining.Ø³Ù…Ùƒ, c.remaining.Ø³Ù†Ø§Ùƒ
      ].join(",") + "\n";
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "clients.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  });
}

// Ø¹Ø±Ø¶ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadFromDB();
</script>
</body>
</html>
