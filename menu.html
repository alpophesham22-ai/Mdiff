<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>القائمة - إدارة اشتراكات المطعم</title>

<link rel="manifest" href="manifest.json">

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log('Service Worker مسجل بنجاح'))
    .catch(() => console.log('فشل تسجيل Service Worker'));
}
</script>

<style>
body { font-family: system-ui, sans-serif; margin: 18px; }
button { font-size: 16px; padding: 12px; margin: 6px 0; width: 100%; }
h1 { margin-bottom: 12px; }
#clients { margin-top: 20px; }
.client {
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 10px;
}
.client-buttons {
  margin-top: 8px;
  display: flex;
  gap: 8px;
}
.client-buttons button {
  flex: 1;
  padding: 8px;
  font-size: 14px;
  cursor: pointer;
}
</style>
</head>
<body>
  <h1>📋 القائمة الرئيسية</h1>
  <button onclick="location.href='add.html'">➕ إضافة عميل</button>
  <button onclick="location.href='consume.html'">🍽️ تسجيل استهلاك وجبة</button>
  <button onclick="location.href='import.html'">⬆️ استيراد / ⬇️ تصدير بيانات</button>

  <h2>👥 العملاء المسجلون</h2>
  <div id="clients">جاري تحميل البيانات...</div>

  <p style="color:#666; margin-top: 20px;">
    افتح هذا الملف في متصفح Chrome. بعد التشغيل الأول، يمكن إضافته للشاشة الرئيسية لتشغيله كتطبيق مستقل.
  </p>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjcqetH5vq7fZSV4vwPib-MIoHt4qrVBk",
      authDomain: "make-difference.firebaseapp.com",
      projectId: "make-difference",
      storageBucket: "make-difference.appspot.com",
      messagingSenderId: "114117498973",
      appId: "1:114117498973:web:87567e7a3a181c88e4d5b4",
      measurementId: "G-YWWMPR5NTY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadClients() {
      const container = document.getElementById("clients");
      container.innerHTML = "جاري تحميل البيانات...";

      try {
        const querySnapshot = await getDocs(collection(db, "subscriptions"));
        if (querySnapshot.empty) {
          container.innerHTML = "<p>لا يوجد عملاء مسجلون بعد.</p>";
          return;
        }

        container.innerHTML = "";
        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const div = document.createElement("div");
          div.className = "client";
          div.innerHTML = `
            <strong>📌 ${data.name}</strong><br>
            ☎️ ${data.phone}<br>
            🆔 ${data.id}<br>
            🥗 اشتراك: ${data.subName || "-"}<br>
            📅 من ${data.startDate} إلى ${data.endDate}
          `;

          // أزرار التعديل والحذف
          const btns = document.createElement("div");
          btns.className = "client-buttons";

          const editBtn = document.createElement("button");
          editBtn.textContent = "✏️ تعديل";
          editBtn.onclick = () => {
            location.href = `search.html?doc=${docSnap.id}`;
          };

          const delBtn = document.createElement("button");
          delBtn.textContent = "🗑️ حذف";
          delBtn.style.background = "#f44336";
          delBtn.style.color = "#fff";
          delBtn.onclick = async () => {
            if (confirm("هل أنت متأكد أنك تريد حذف هذا العميل؟")) {
              await deleteDoc(doc(db, "subscriptions", docSnap.id));
              alert("تم الحذف ✅");
              loadClients(); // إعادة تحميل القائمة بعد الحذف
            }
          };

          btns.appendChild(editBtn);
          btns.appendChild(delBtn);
          div.appendChild(btns);

          container.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        container.innerHTML = "<p style='color:red'>فشل تحميل البيانات من Firebase.</p>";
      }
    }

    loadClients();
  </script>
</body>
</html>
