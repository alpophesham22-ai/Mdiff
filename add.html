<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>إضافة عميل</title>
<style>
body { font-family: system-ui, sans-serif; margin: 16px; }
label { display: block; margin-top: 8px; }
input, button, select { font-size: 16px; padding: 8px; width: 100%; box-sizing: border-box; }
button { margin-top: 12px; }
#msg { color: green; margin-top: 10px; }
</style>
</head>
<body>
  <h1>➕ إضافة عميل</h1>

  <label>ID (أدخل بنفسك)</label><input id="id">
  <label>الاسم</label><input id="name">
  <label>الجوال</label><input id="phone" placeholder="05XXXXXXXX">
  <label>اسم الاشتراك (خانة حرة)</label><input id="subName">
  <label>مدة الاشتراك</label>
  <select id="duration"><option value="14">14 يوم</option><option value="40" selected>40 يوم</option></select>
  <label>تاريخ البداية</label><input id="start" type="date">
  <label>إجمالي الوجبات المسموحة</label><input id="totalAllowed" type="number" min="0" placeholder="مثال: 30">

  <div style="display:grid;grid-template-columns:1fr 1fr; gap:8px; margin-top:8px;">
    <div><label>عدد وجبات دجاج</label><input id="chicken" type="number" min="0" value="0"></div>
    <div><label>عدد وجبات لحم</label><input id="meat" type="number" min="0" value="0"></div>
    <div><label>عدد وجبات سمك</label><input id="fish" type="number" min="0" value="0"></div>
    <div><label>عدد وجبات سناك</label><input id="snack" type="number" min="0" value="0"></div>
  </div>

  <button id="save">حفظ العميل</button>
  <p id="msg"></p>
  <hr>
  <button onclick="location.href='menu.html'">⬅ القائمة الرئيسية</button>

<script>
const DB='subsDB_final', STORE='subs';
const DAY_MS=24*60*60*1000;

function openDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open(DB,1);
    r.onupgradeneeded = e => { e.target.result.createObjectStore(STORE, {keyPath:'id'}); };
    r.onsuccess = () => res(r.result);
    r.onerror = () => rej(r.error);
  });
}

function put(sub) {
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).put(sub);
    tx.oncomplete = () => res();
    tx.onerror = () => rej(tx.error);
  });
}

let db;
openDB().then(d => { db = d; 
  let today = new Date().toISOString().slice(0,10); 
  document.getElementById('start').value = today;
});

document.getElementById('save').addEventListener('click', async () => {
  const id = document.getElementById('id').value.trim();
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const subName = document.getElementById('subName').value.trim();
  const duration = parseInt(document.getElementById('duration').value,10);
  const start = document.getElementById('start').value;
  const totalAllowedInput = parseInt(document.getElementById('totalAllowed').value);
  const chicken = parseInt(document.getElementById('chicken').value)||0;
  const meat = parseInt(document.getElementById('meat').value)||0;
  const fish = parseInt(document.getElementById('fish').value)||0;
  const snack = parseInt(document.getElementById('snack').value)||0;

  if(!id||!name||!phone||!start){ alert('املأ الحقول الأساسية'); return; }

  const sumTypes = chicken + meat + fish + snack;
  const totalAllowed = (!isNaN(totalAllowedInput) && totalAllowedInput>0) ? totalAllowedInput : sumTypes;

  const sub = {
    id, name, phone, subName, duration, startDate:start,
    endDate: new Date(new Date(start).getTime() + duration*DAY_MS).toISOString().slice(0,10),
    totalAllowed,
    consumed:{دجاج:0,لحم:0,سمك:0,سناك:0},
    remaining:{دجاج:chicken,لحم:meat,سمك:fish,سناك:snack},
    createdAt:new Date().toISOString()
  };

  await put(sub);
  document.getElementById('msg').textContent = 'تم حفظ العميل.';
  setTimeout(()=>location.href='menu.html',700);
});
</script>
</body>
</html>