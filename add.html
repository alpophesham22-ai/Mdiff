<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, addDoc } 
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // إعدادات Firebase الخاصة بك
  const firebaseConfig = {
    apiKey: "AIzaSyAjcqetH5vq7fZSV4vwPib-MIoHt4qrVBk",
    authDomain: "make-difference.firebaseapp.com",
    projectId: "make-difference",
    storageBucket: "make-difference.appspot.com",
    messagingSenderId: "114117498973",
    appId: "1:114117498973:web:87567e7a3a181c88e4d5b4",
    measurementId: "G-YWWMPR5NTY"
  };

  // تهيئة Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const DAY_MS = 24*60*60*1000;

  document.getElementById('save').addEventListener('click', async () => {
    const id = document.getElementById('id').value.trim();
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const subName = document.getElementById('subName').value.trim();
    const duration = parseInt(document.getElementById('duration').value,10);
    const start = document.getElementById('start').value;
    const totalAllowedInput = parseInt(document.getElementById('totalAllowed').value);
    const chicken = parseInt(document.getElementById('chicken').value)||0;
    const meat = parseInt(document.getElementById('meat').value)||0;
    const fish = parseInt(document.getElementById('fish').value)||0;
    const snack = parseInt(document.getElementById('snack').value)||0;

    if(!id || !name || !phone || !start) {
      alert('املأ الحقول الأساسية');
      return;
    }

    const sumTypes = chicken + meat + fish + snack;
    const totalAllowed = (!isNaN(totalAllowedInput) && totalAllowedInput>0) ? totalAllowedInput : sumTypes;

    const sub = {
      id, name, phone, subName, duration, startDate: start,
      endDate: new Date(new Date(start).getTime() + duration*DAY_MS).toISOString().slice(0,10),
      totalAllowed,
      consumed: {دجاج:0, لحم:0, سمك:0, سناك:0},
      remaining: {دجاج:chicken, لحم:meat, سمك:fish, سناك:snack},
      createdAt: new Date().toISOString()
    };

    try {
      // حفظ البيانات في Firestore
      await addDoc(collection(db, "subscriptions"), sub);

      document.getElementById('msg').textContent = '✅ تم حفظ العميل في قاعدة بيانات Firebase.';
      setTimeout(()=>location.href='menu.html', 700);
    } catch(err) {
      console.error(err);
      alert('❌ حدث خطأ أثناء إرسال البيانات إلى Firebase.');
    }
  });
</script>
