<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ ÙˆØ¬Ø¨Ø©</title>
<style>
body { font-family: system-ui, sans-serif; margin: 16px; }
label { display: block; margin-top: 8px; }
input, select, button { font-size: 16px; padding: 8px; width: 100%; box-sizing: border-box; }
button { margin-top: 12px; }
#msg { margin-top: 12px; color: green; }
</style>
</head>
<body>
<h1>ğŸ½ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ ÙˆØ¬Ø¨Ø©</h1>

<label>Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ ID</label>
<input id="id" placeholder="Ø§Ø¯Ø®Ù„ ID Ø§Ù„Ø¹Ù…ÙŠÙ„">
<label>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©</label>
<select id="mealType">
  <option value="Ø¯Ø¬Ø§Ø¬">Ø¯Ø¬Ø§Ø¬</option>
  <option value="Ù„Ø­Ù…">Ù„Ø­Ù…</option>
  <option value="Ø³Ù…Ùƒ">Ø³Ù…Ùƒ</option>
  <option value="Ø³Ù†Ø§Ùƒ">Ø³Ù†Ø§Ùƒ</option>
</select>
<label>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</label>
<input id="count" type="number" min="1" value="1">

<button id="consumeBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</button>
<p id="msg"></p>
<hr>
<button onclick="location.href='menu.html'">â¬… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<script>
const DB='subsDB_final', STORE='subs';

function openDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open(DB,1);
    r.onupgradeneeded = e => { e.target.result.createObjectStore(STORE, {keyPath:'id'}); };
    r.onsuccess = () => res(r.result);
    r.onerror = () => rej(r.error);
  });
}

function getSub(id) {
  return new Promise(async (res, rej) => {
    const db = await openDB();
    const tx = db.transaction(STORE,'readonly');
    const store = tx.objectStore(STORE);
    const req = store.get(id);
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

function putSub(sub) {
  return new Promise(async (res, rej) => {
    const db = await openDB();
    const tx = db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).put(sub);
    tx.oncomplete = () => res();
    tx.onerror = () => rej(tx.error);
  });
}

function checkStatus(sub){
  const today = new Date();
  const endDate = new Date(sub.endDate);
  let reason='';
  if(today > endDate) reason='Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø³Ø¨Ø¨ Ù…Ø±ÙˆØ± Ø§Ù„Ø£ÙŠØ§Ù…';
  else {
    const remainingMeals = Object.values(sub.remaining).reduce((a,b)=>a+b,0);
    if(remainingMeals <= 0) reason='Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø³Ø¨Ø¨ Ù†ÙØ§Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª';
  }
  return reason || 'Ø³Ø§Ø±ÙŠ';
}

document.getElementById('consumeBtn').addEventListener('click', async ()=>{
  const id = document.getElementById('id').value.trim();
  const meal = document.getElementById('mealType').value;
  const count = parseInt(document.getElementById('count').value);
  const msg = document.getElementById('msg');

  if(!id||!meal||isNaN(count)||count<1){ alert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­'); return; }

  const sub = await getSub(id);
  if(!sub){ alert('Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

  const status = checkStatus(sub);
  if(status!=='Ø³Ø§Ø±ÙŠ'){ msg.textContent='Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ. Ø§Ù„Ø­Ø§Ù„Ø©: '+status; return; }

  if(sub.remaining[meal] < count){ msg.textContent='Ø§Ù„ÙƒÙ…ÙŠØ© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ÙˆØ¬Ø¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©'; return; }

  sub.remaining[meal] -= count;
  sub.consumed[meal] += count;

  await putSub(sub);
  msg.textContent=`ØªÙ… Ø®ØµÙ… ${count} ÙˆØ¬Ø¨Ø© Ù…Ù† ${meal}. Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${sub.remaining[meal]}`;
});
</script>
</body>
</html>